<!DOCTYPE html>
<html lang='en'>
  <head>
    <meta charset='utf-8' />
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js'></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script type="module">
      import CONFIG from './config.js';

      const CLIENT_ID = CONFIG.CLIENT_ID;
      const API_KEY = CONFIG.API_KEY;
      const SCOPES = "https://www.googleapis.com/auth/calendar.events";
      const CALENDAR_ID = CONFIG.GOOGLE_CALENDAR_ID;

      let calendar;

      function handleClientLoad() {
        gapi.load('client', initClient);
      }

      async function initClient() {
        try {
          await gapi.client.init({
            apiKey: API_KEY,
            clientId: CLIENT_ID,
            discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"],
            scope: SCOPES
          });
          console.log("✅ Google API Initialized");

          // 로그인 상태 확인
          if (gapi.auth.getToken()) {
            console.log("✅ 이미 로그인됨");
          }
        } catch (error) {
          console.error("❌ Google API Initialization Failed:", error);
        }
      }

      async function handleAuthClick() {
        try {
          const tokenResponse = await gapi.auth.authorize({
            client_id: CLIENT_ID,
            scope: SCOPES
          });

          if (tokenResponse) {
            gapi.client.setToken(tokenResponse);
            alert("Google 로그인 성공!");
          }
        } catch (error) {
          console.error("❌ Google 로그인 실패", error);
        }
      }

      async function addEventToGoogleCalendar(eventInfo) {
        if (!gapi.client.getToken()) {
          alert("🚨 로그인이 필요합니다!");
          return;
        }

        const event = {
          summary: eventInfo.title,
          start: { dateTime: eventInfo.startStr },
          end: { dateTime: eventInfo.endStr || eventInfo.startStr }
        };

        try {
          await gapi.client.calendar.events.insert({
            calendarId: 'primary',
            resource: event
          });
          alert('✅ 이벤트가 Google Calendar에 추가되었습니다!');
          calendar.refetchEvents();
        } catch (error) {
          console.error('❌ 이벤트 추가 실패:', error);
        }
      }

      document.addEventListener('DOMContentLoaded', function() {
        var calendarEl = document.getElementById('calendar');
        calendar = new FullCalendar.Calendar(calendarEl, {
          initialView: 'dayGridMonth',
          googleCalendarApiKey: API_KEY,
          events: {
            googleCalendarId: CALENDAR_ID
          },
          selectable: true,
          select: function(info) {
            let title = prompt("📌 이벤트 제목을 입력하세요:");
            if (title) {
              let newEvent = {
                title: title,
                startStr: info.startStr,
                endStr: info.endStr
              };
              addEventToGoogleCalendar(newEvent);
            }
          }
        });
        calendar.render();
      });
    </script>
  </head>
  <body onload="handleClientLoad()">
    <button onclick="handleAuthClick()">🔑 Google 로그인</button>
    <div id='calendar'></div>
  </body>
</html>
