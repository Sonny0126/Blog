<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Google Calendar Integration</title>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
    <script src="https://apis.google.com/js/api.js" onload="gapiLoad()"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script>
        const CLIENT_ID = 'YOUR_CLIENT_ID';  // ✅ 보안 유지
        const API_KEY = 'YOUR_API_KEY';
        const SCOPES = 'https://www.googleapis.com/auth/calendar.events';

        let tokenClient;
        let gapiLoaded = false;

        function gapiLoad() {
            if (typeof gapi === 'undefined') {
                console.error("❌ gapi 객체가 아직 로드되지 않았습니다.");
                return;
            }

            gapi.load('client', async () => {
                await gapi.client.init({
                    apiKey: API_KEY,
                    discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"]
                });
                gapiLoaded = true;
                console.log("✅ Google API 로드 완료");
                gisLoad();
            });
        }

        function gisLoad() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                prompt: 'consent',
                callback: (response) => {
                    if (response.error) {
                        console.error('❌ OAuth 로그인 실패:', response);
                        return;
                    }
                    console.log('✅ OAuth 로그인 성공:', response);
                    gapi.client.setToken(response);
                    localStorage.setItem('google_token', JSON.stringify(response));
                }
            });

            const savedToken = localStorage.getItem('google_token');
            if (savedToken) {
                gapi.client.setToken(JSON.parse(savedToken));
                console.log("🔄 기존 로그인 토큰 복원 완료");
            }
        }

        function handleAuthClick() {
            if (!gapiLoaded) {
                alert('Google API가 아직 로드되지 않았습니다.');
                return;
            }
            tokenClient.requestAccessToken({ prompt: 'consent' });
        }

        async function addEventToGoogleCalendar(eventInfo) {
            if (!gapi.client.getToken()) {
                alert('먼저 Google 로그인을 해주세요!');
                return;
            }

            const event = {
                summary: eventInfo.title,
                description: eventInfo.description,
                start: { dateTime: new Date(eventInfo.startStr).toISOString(), timeZone: 'Asia/Seoul' },
                end: { dateTime: new Date(eventInfo.endStr).toISOString(), timeZone: 'Asia/Seoul' }
            };

            try {
                await gapi.client.calendar.events.insert({
                    calendarId: 'primary',
                    resource: event
                });
                alert('이벤트가 Google Calendar에 추가되었습니다!');
            } catch (err) {
                console.error('❌ 이벤트 추가 실패:', err);
                alert('이벤트 추가에 실패했습니다.');
            }
        }

        window.onload = function() {
            if (typeof gapi !== 'undefined') {
                gapiLoad();
            } else {
                console.warn("⏳ Google API가 아직 로드되지 않았습니다. 잠시 후 다시 시도하세요.");
            }
        };

        document.addEventListener('DOMContentLoaded', function() {
            var calendarEl = document.getElementById('calendar');
            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                selectable: true,
                select: function(info) {
                    let title = prompt("이벤트 제목을 입력하세요:");
                    let description = prompt("이벤트 설명을 입력하세요:");
                    if (title) {
                        let newEvent = { title, description, startStr: info.startStr, endStr: info.endStr };
                        addEventToGoogleCalendar(newEvent);
                        calendar.addEvent(newEvent);
                    }
                }
            });
            calendar.render();
        });
    </script>
</head>
<body>
    <button onclick="handleAuthClick()">Google 로그인</button>
    <div id="calendar"></div>
</body>
</html>
