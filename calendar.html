<!DOCTYPE html>
<html lang='en'>
  <head>
    <meta charset='utf-8' />
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js'></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script type="module">
      import CONFIG from './config.js';

      const CLIENT_ID = CONFIG.CLIENT_ID;
      const API_KEY = CONFIG.API_KEY;
      const SCOPES = "https://www.googleapis.com/auth/calendar.events";
      const CALENDAR_ID = CONFIG.GOOGLE_CALENDAR_ID;

      let calendar;

      function handleClientLoad() {
        gapi.load('client', initClient);
      }

      async function initClient() {
        try {
          await gapi.client.init({
            apiKey: API_KEY,
            clientId: CLIENT_ID,
            discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"],
            scope: SCOPES
          });
          console.log("âœ… Google API Initialized");

          // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
          if (gapi.auth.getToken()) {
            console.log("âœ… ì´ë¯¸ ë¡œê·¸ì¸ë¨");
          }
        } catch (error) {
          console.error("âŒ Google API Initialization Failed:", error);
        }
      }

      async function handleAuthClick() {
        try {
          const tokenResponse = await gapi.auth.authorize({
            client_id: CLIENT_ID,
            scope: SCOPES
          });

          if (tokenResponse) {
            gapi.client.setToken(tokenResponse);
            alert("Google ë¡œê·¸ì¸ ì„±ê³µ!");
          }
        } catch (error) {
          console.error("âŒ Google ë¡œê·¸ì¸ ì‹¤íŒ¨", error);
        }
      }

      async function addEventToGoogleCalendar(eventInfo) {
        if (!gapi.client.getToken()) {
          alert("ğŸš¨ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤!");
          return;
        }

        const event = {
          summary: eventInfo.title,
          start: { dateTime: eventInfo.startStr },
          end: { dateTime: eventInfo.endStr || eventInfo.startStr }
        };

        try {
          await gapi.client.calendar.events.insert({
            calendarId: 'primary',
            resource: event
          });
          alert('âœ… ì´ë²¤íŠ¸ê°€ Google Calendarì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!');
          calendar.refetchEvents();
        } catch (error) {
          console.error('âŒ ì´ë²¤íŠ¸ ì¶”ê°€ ì‹¤íŒ¨:', error);
        }
      }

      document.addEventListener('DOMContentLoaded', function() {
        var calendarEl = document.getElementById('calendar');
        calendar = new FullCalendar.Calendar(calendarEl, {
          initialView: 'dayGridMonth',
          googleCalendarApiKey: API_KEY,
          events: {
            googleCalendarId: CALENDAR_ID
          },
          selectable: true,
          select: function(info) {
            let title = prompt("ğŸ“Œ ì´ë²¤íŠ¸ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”:");
            if (title) {
              let newEvent = {
                title: title,
                startStr: info.startStr,
                endStr: info.endStr
              };
              addEventToGoogleCalendar(newEvent);
            }
          }
        });
        calendar.render();
      });
    </script>
  </head>
  <body onload="handleClientLoad()">
    <button onclick="handleAuthClick()">ğŸ”‘ Google ë¡œê·¸ì¸</button>
    <div id='calendar'></div>
  </body>
</html>
