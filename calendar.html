<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Google Calendar Integration</title>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
    <script src="https://apis.google.com/js/api.js" onload="gapiLoad()"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script>
        const CLIENT_ID = 'YOUR_CLIENT_ID';  // âœ… ë³´ì•ˆ ìœ ì§€
        const API_KEY = 'YOUR_API_KEY';
        const SCOPES = 'https://www.googleapis.com/auth/calendar.events';

        let tokenClient;
        let gapiLoaded = false;

        function gapiLoad() {
            if (typeof gapi === 'undefined') {
                console.error("âŒ gapi ê°ì²´ê°€ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                return;
            }

            gapi.load('client', async () => {
                await gapi.client.init({
                    apiKey: API_KEY,
                    discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"]
                });
                gapiLoaded = true;
                console.log("âœ… Google API ë¡œë“œ ì™„ë£Œ");
                gisLoad();
            });
        }

        function gisLoad() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                prompt: 'consent',
                callback: (response) => {
                    if (response.error) {
                        console.error('âŒ OAuth ë¡œê·¸ì¸ ì‹¤íŒ¨:', response);
                        return;
                    }
                    console.log('âœ… OAuth ë¡œê·¸ì¸ ì„±ê³µ:', response);
                    gapi.client.setToken(response);
                    localStorage.setItem('google_token', JSON.stringify(response));
                }
            });

            const savedToken = localStorage.getItem('google_token');
            if (savedToken) {
                gapi.client.setToken(JSON.parse(savedToken));
                console.log("ğŸ”„ ê¸°ì¡´ ë¡œê·¸ì¸ í† í° ë³µì› ì™„ë£Œ");
            }
        }

        function handleAuthClick() {
            if (!gapiLoaded) {
                alert('Google APIê°€ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return;
            }
            tokenClient.requestAccessToken({ prompt: 'consent' });
        }

        async function addEventToGoogleCalendar(eventInfo) {
            if (!gapi.client.getToken()) {
                alert('ë¨¼ì € Google ë¡œê·¸ì¸ì„ í•´ì£¼ì„¸ìš”!');
                return;
            }

            const event = {
                summary: eventInfo.title,
                description: eventInfo.description,
                start: { dateTime: new Date(eventInfo.startStr).toISOString(), timeZone: 'Asia/Seoul' },
                end: { dateTime: new Date(eventInfo.endStr).toISOString(), timeZone: 'Asia/Seoul' }
            };

            try {
                await gapi.client.calendar.events.insert({
                    calendarId: 'primary',
                    resource: event
                });
                alert('ì´ë²¤íŠ¸ê°€ Google Calendarì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!');
            } catch (err) {
                console.error('âŒ ì´ë²¤íŠ¸ ì¶”ê°€ ì‹¤íŒ¨:', err);
                alert('ì´ë²¤íŠ¸ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        window.onload = function() {
            if (typeof gapi !== 'undefined') {
                gapiLoad();
            } else {
                console.warn("â³ Google APIê°€ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.");
            }
        };

        document.addEventListener('DOMContentLoaded', function() {
            var calendarEl = document.getElementById('calendar');
            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                selectable: true,
                select: function(info) {
                    let title = prompt("ì´ë²¤íŠ¸ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”:");
                    let description = prompt("ì´ë²¤íŠ¸ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”:");
                    if (title) {
                        let newEvent = { title, description, startStr: info.startStr, endStr: info.endStr };
                        addEventToGoogleCalendar(newEvent);
                        calendar.addEvent(newEvent);
                    }
                }
            });
            calendar.render();
        });
    </script>
</head>
<body>
    <button onclick="handleAuthClick()">Google ë¡œê·¸ì¸</button>
    <div id="calendar"></div>
</body>
</html>
